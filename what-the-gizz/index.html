<!DOCTYPE html>
<html>
	<head>
		<title>What the Gizz?!</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<script
			  src="https://code.jquery.com/jquery-2.2.4.min.js"
			  integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
			  crossorigin="anonymous"></script>
		<script type="text/javascript" src="all_lyrics.js"></script>
		<script language="javascript">
			console.log(all_lyrics);
			
			// Some emojis for result display
			const symbols_correct   = ['🥳', '🤩', '☺', '😃', '😄', '😆'];
			const symbols_incorrect = ['🫢', '🫣', '🤔', '🤨', '😧', '😱'];
			const symbols_gameover  = ['😵', '😵‍💫', '😖', '😭', '🤬'];
			
			// Load songs from JSON
			var songs = [];
			var song_names = [];
			loadSongData();

			// Setup internal variables
			var current_song = null;
			var current_song_name = null;

			var uniq_lyrics = [];
			var num_lyrics = 0;

			// Restore last guess count
			var guessed_count = 0;

			function loadSongData() {
				songs = [];
				all_lyrics.albums.forEach((album) => {
					album.songs.forEach((song) => {
						songs.push(song);
						song_names.push(song.name);
					});
				});
				
				song_names.sort();
				console.log("Loaded songs: ", song_names);
			}
			
			function chooseNewSong() {
				while (true) {
					current_song = randomChoice(songs);
					current_song_name = current_song.name.toLowerCase();
					console.log("Set current song: ", current_song.name);
					
					updateSongLyrics();
					
					if (num_lyrics > 3)
						break;
						
					console.log("Not enough lines, choosing new song.");
				}

				guessed_count = 0;
			}
			
			function updateSongLyrics() {
				uniq_lyrics = [...new Set(current_song.lyrics)];
				num_lyrics = uniq_lyrics.length;
				console.log("Number of unique lines: ", num_lyrics);
			}

			// Function to choose random entry from input array
			function randomIndex(arr) {
				var index = Math.floor(arr.length * Math.random());
				if (index >= arr.length)
					index = arr.length - 1;
				return index;
			}
			
			function randomChoice(arr) {
				return arr[randomIndex(arr)];
			}
			
			// Update the user prompt
			function updatePrompt() {
				var line_index = randomIndex(uniq_lyrics);		
				console.log("Choosing line no.: ", line_index);
				
				lyrics_line = uniq_lyrics[line_index];
				uniq_lyrics.splice(line_index, 1);  // remove line

				$('#lyrics-line').html("»&nbsp;" + lyrics_line + "&nbsp;«");
				//$('#guessed-name').val("");
			}
			
			function resetGame() {
				chooseNewSong();
				updatePrompt();
				
				$('#guessed-name').val("");

				$('#result-correct').hide();
				$('#result-incorrect').hide();
				$('#result-gameover').hide();
				$('#submit').prop('disabled', false);
			}
			
			// Process user input
			function submitGuess() {
				var guessed_name = $('#guessed-name').val().trim().toLowerCase();
				var guessed_correctly = false;
				var game_over = false;
				
				console.log("Submitted guess: ", guessed_name);
				if (guessed_name == "") {
					console.log("Answer is empty - try again!");
					return;
				}
				else if (guessed_name != current_song_name) {
					guessed_correctly = false;
					console.log("Guessed incorrectly.");
					
					updatePrompt();
				}
				else {
					guessed_correctly = true;
					console.log("Guessed correctly.");
				}
			
				guessed_count++;
				console.log("Current guess count: ", guessed_count);

				if (guessed_count >= num_lyrics || uniq_lyrics.length == 0)
					game_over = true;
				
				var guessed_text = guessed_count + " guesses";
				if (guessed_count == 1) {
					guessed_text = guessed_count + " guess";
				}
				
				if (game_over) {
					var symbol = randomChoice(symbols_gameover);
					$('#symbol-gameover-1').html(symbol);
					$('#symbol-gameover-2').html(symbol);
					$('#guessed-count-gameover').html(guessed_text);				
					$('#correct-answer').html(current_song.name);
					$('#result-correct').hide();
					$('#result-incorrect').hide();
					$('#result-gameover').show();
					$('#submit').prop('disabled', true);
				}
				else if (guessed_correctly) {
					var symbol = randomChoice(symbols_correct);
					$('#symbol-correct-1').html(symbol);
					$('#symbol-correct-2').html(symbol);
					$('#guessed-count-correct').html(guessed_text);				
					$('#result-correct').show();
					$('#result-incorrect').hide();
					$('#result-gameover').hide();
					$('#submit').prop('disabled', true);
				}
				else {
					var symbol = randomChoice(symbols_incorrect);
					$('#symbol-incorrect-1').html(symbol);
					$('#symbol-incorrect-2').html(symbol);
					$('#guessed-count-incorrect').html(guessed_text);				
					$('#result-incorrect').show();
					$('#result-correct').hide();
					$('#result-gameover').hide();
					$('#submit').prop('disabled', false);
				}
			}
			
			$(document).ready(function() {
				resetGame();
			});
		</script>
		<script language="javascript">
			function autocomplete(inp, arr) {
				var currentFocus;
				
				console.log(arr);

				inp.addEventListener("input", function(e) {
					var a, b, i, val = this.value;
					closeAllLists();
					if (!val) { return false;}
					currentFocus = -1;

					a = document.createElement("DIV");
					a.setAttribute("id", this.id + "autocomplete-list");
					a.setAttribute("class", "autocomplete-items");
					this.parentNode.appendChild(a);

					for (i = 0; i < arr.length; i++) {
						if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
							b = document.createElement("DIV");
							b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
							b.innerHTML += arr[i].substr(val.length);
							b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";

							b.addEventListener("click", function(e) {
								inp.value = this.getElementsByTagName("input")[0].value;
								closeAllLists();
							});
							a.appendChild(b);
						}
					}
				});

				inp.addEventListener("keydown", function(e) {
					var x = document.getElementById(this.id + "autocomplete-list");
					if (x) x = x.getElementsByTagName("div");
					if (e.keyCode == 40) { // down
						currentFocus++;
						addActive(x);
					} else if (e.keyCode == 38) { // up
						currentFocus--;
						addActive(x);
					} else if (e.keyCode == 13) { // enter
						e.preventDefault();
						if (currentFocus > -1) {
							if (x) x[currentFocus].click();
						}
					}
				});
				
				function addActive(x) {
					if (!x) return false;
					
					removeActive(x);
					if (currentFocus >= x.length) currentFocus = 0;
					if (currentFocus < 0) currentFocus = (x.length - 1);
					x[currentFocus].classList.add("autocomplete-active");
				}
				
				function removeActive(x) {
					for (var i = 0; i < x.length; i++) {
						x[i].classList.remove("autocomplete-active");
					}
				}
				
				function closeAllLists(elmnt) {
					var x = document.getElementsByClassName("autocomplete-items");
					for (var i = 0; i < x.length; i++) {
						if (elmnt != x[i] && elmnt != inp) {
							x[i].parentNode.removeChild(x[i]);
						}
					}
				}

				document.addEventListener("click", function (e) {
					closeAllLists(e.target);
				});
				
				inp.addEventListener('focus', () => inp.select());
			} 
		
			$(document).ready(function() {
				autocomplete(document.getElementById("guessed-name"), song_names);
			});
		</script>
		<style>
			body {
				background-color: #333;
				color: #FFF;
				text-align: center;
				max-width: 1000px;
				text-align: center;
				margin: 50px auto;
				font-family: Verdana,Arial,Helvetica,sans-serif;
				font-size: 17pt;
			}
			
			@media screen and (max-width:769px) {
				body {
					font-size: 17pt;
					font-size: 3vw;
				}
			}
			
			@keyframes result-anim {
				from {
					transform: rotate(-1.8deg);
				}
				to {
					transform: rotate(1.8deg);
				}
			}
			
			.result {
				font-size: 120%;
				margin-top: 50px;
				animation: result-anim 1s ease-in-out 0s infinite alternate;
			}
			
			.symbol {
				font-size: 150%;
			}
			
			.autocomplete {
				position: relative;
				display: inline-block;
			}
			
			.autocomplete-items {
				position: absolute;
				margin-top: -10px;
				z-index: 99;
				top: 100%;
				left: 0;
				right: 0;
			}
			.autocomplete-items div {
				margin: 0px 16px;
				cursor: pointer;
				background-color: #666;
				border: 2px solid #6ba1f3;
				border-top: none;
			}
			.autocomplete-items div:hover {
				background-color: #999;
			}
			.autocomplete-active {
				background-color: #6ba1f3 !important;
				color: #fff;
			}

			#result-correct,
			#result-incorrect,
			#result-gameover {
				display: none;
			}
			
			#lyrics-line {
				font-size: 120%;
				font-style: italic;
				font-weight: bold;
				background-color: #2f864d;
				border: 2px solid #50d22d;
				border-radius: 12px;
				padding: 20px;
				margin: 20px 100px;
			}
			
			#next-guess {
				font-size: 120%;
			}
			
			#guessed-name {
				font-size: 110%;
				margin: 10px;
				padding: 6px;
				color: #FFF;
				background-color: #666;
				border: 2px solid #6ba1f3;
				border-radius: 6px;
				text-align: center;
			}
			
			#submit,
			#reset {
				font-size: 80%;
				padding: 6px 12px;
				margin: 10px 20px;
			}

			#submit {
				background-color: #3ecf97;
				border: 1px solid #3ecf97;
				border-radius: 6px;
			}
			#submit:disabled {
				background-color: #94908b;
			}
			
			#reset {
				background-color: #dc3d7d;
				border: 1px solid #dc3d7d;
				border-radius: 6px;
			}
		</style>
	</head>
	<body>
		<h1>
			What the Gizz?!
		</h1>

		<h2>
			Guess this Gizz song by the following lyrics line:
		</h2>

		<h3 id="lyrics-line">
			???
		</h3>

		<form id="next-guess" name="next-guess">
			<label for="guessed-name">Song Name:</label><br/>
			<div class="autocomplete">
				<input type="text" id="guessed-name" name="guessed-name" size="30"/>
			</div>
		</form>

		<button type="button" id="submit" value="submit" onClick="submitGuess()">Submit!</button>
		<button type="button" id="reset" value="reset" onClick="resetGame()">Reset</button>

		<p id="result-incorrect" class="result">
			<span id="symbol-incorrect-1" class="symbol"></span>
			<b>Incorrect!</b>
			<span id="symbol-incorrect-2" class="symbol"></span>
			<br/>
			You've used <span id="guessed-count-incorrect">0 guesses</span> so far. Try again?
		</p>

		<p id="result-correct" class="result">
			<span id="symbol-correct-1" class="symbol"></span>
			<b>Correct!</b>
			<span id="symbol-correct-2" class="symbol"></span>
			<br/>
			You've used <span id="guessed-count-correct">0 guesses</span> to get there.
		</p>

		<p id="result-gameover" class="result">
			<span id="symbol-gameover-1" class="symbol"></span>
			<b>GAME OVER!</b> 
			<span id="symbol-gameover-2" class="symbol"></span>
			<br/>
			You've used <span id="guessed-count-gameover">0 guesses</span> and there are no more lyrics left.
			<br/>
			The correct answer was: <span id="correct-answer"></span>
		</p>
	</body>
</html>
