!function(e){var t={};function n(a){if(t[a])return t[a].exports;var o=t[a]={i:a,l:!1,exports:{}};return e[a].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,a){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(n.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(a,o,function(t){return e[t]}.bind(null,o));return a},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function a(e){return Math.floor(Math.random()*(e-.01))}function o(e){return e[a(e.length)]}n.r(t),n.d(t,"midiControlPresets",function(){return x}),n.d(t,"midiDrumPresets",function(){return I});var r=function(e,t,n,a){return new(n||(n=Promise))(function(o,r){function c(e){try{u(a.next(e))}catch(e){r(e)}}function i(e){try{u(a.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}u((a=a.apply(e,t||[])).next())})};const c=new Map,i=new Map;function u(e){const t=e.substring(e.length-1),n=e.substring(0,e.length-1);return 12*parseInt(t)+c.get(n)+12}function s(e){return 440*Math.pow(2,(e-69)/12)}function l(e=new(window.AudioContext||window.webkitAudioContext)){function t(){if(e.createConstantSource)return e.createConstantSource();{const t=e.createBufferSource();t.buffer=e.createBuffer(1,256,e.sampleRate);const n=t.buffer.getChannelData(0);for(let e=0;e<n.length;e++)n[e]=1;const a=e.createGain(),o=a.gain;return t.loop=!0,t.connect(a),Object.assign(a,{offset:o,start:()=>t.start()})}}function n(e=50,t=20){const n=new Float32Array(256),a=Math.PI/180;for(let o=0;o<256;++o){const r=2*o/256-1;n[o]=(3+e)*r*t*a/(Math.PI+e*Math.abs(r))}return n}const a=function(){const t=e.createGain();t.gain.value=.5;const n=e.createDynamicsCompressor();n.attack.value=.005,n.release.value=.1,n.ratio.value=15,n.knee.value=0,n.threshold.value=-.5;const a=e.createAnalyser();return a.fftSize=2048,n.connect(a),t.connect(n),n.connect(e.destination),{in:t,analyser:a}}();function o(e){return new Promise(t=>{setTimeout(()=>t(),1e3*e)})}function c(t,n,c,i,u=0,s=a.in){return r(this,void 0,void 0,function*(){const a=e.createOscillator();a.type="sawtooth",a.frequency.value=t,a.start();const r=e.createBiquadFilter();r.type="lowpass",r.frequency.value=4*t,r.Q.value=5;const l=e.createGain();l.gain.value=0;const d=e.createPanner();d.panningModel="equalpower",d.setPosition(u,0,1-Math.abs(u)),a.connect(r),r.connect(l),l.connect(d),d.connect(s),l.gain.linearRampToValueAtTime(.1,e.currentTime+n),yield o(c+n),l.gain.setValueAtTime(.1,e.currentTime),l.gain.linearRampToValueAtTime(0,e.currentTime+i),r.frequency.linearRampToValueAtTime(Math.max(t/2,400),e.currentTime+i),yield o(i+.01),a.stop(e.currentTime),d.disconnect()})}function i(t){return r(this,void 0,void 0,function*(){const n=yield fetch(t),a=yield n.arrayBuffer();var o;return yield(o=a,new Promise((t,n)=>e.decodeAudioData(o,t,n)))})}function l(t){return r(this,void 0,void 0,function*(){const n=yield i(t);return{play:function(t=.4,o=1,r=a.in){const c=e.createBufferSource();c.buffer=n,c.loop=!1;const i=e.createGain();i.gain.setValueAtTime(t,e.currentTime),i.gain.linearRampToValueAtTime(0,e.currentTime+o),c.connect(i),i.connect(r),c.start(e.currentTime)}}})}return{tone:c,SimpleToneSynth:function(e,t,n,o=a.in){return{play:function(a){c(function(e){return s("number"==typeof e?e:u(e))}(a),e,t,n,2*Math.random()-1,o)}}},DelayInsert:function(t,n,o,r=a.in){const c=e.createDelay(1);c.delayTime.value=t;const i=e.createGain();i.gain.value=n,c.connect(i),i.connect(c);const u=e.createGain();u.gain.value=o,c.connect(u),u.connect(r);const s=e.createGain();return s.gain.value=1,s.connect(c),s.connect(r),{in:s,feedback:i.gain,wet:u.gain,delayTime:c.delayTime}},ThreeOh:function(o="sawtooth",r=a.in){const c=e.createBiquadFilter();c.type="lowpass",c.Q.value=20,c.frequency.value=300;const i=c.Q,l=c.frequency,d=t();d.start();const m=d.offset,f=t();f.start(),f.offset.value=0;const v=e.createGain();v.gain.value=0;const p=v.gain,h=e.createWaveShaper();let g=p.value;h.curve=n(g),h.oversample="4x";const b=e.createGain();b.gain.value=4e3;const C=b.gain;f.connect(b),b.connect(c.detune);const y=e.createOscillator();y.type=o,y.frequency.value=440,y.start();const M=e.createGain();return M.gain.value=0,y.connect(M),M.connect(c),c.connect(h),h.connect(r),{noteOn:function(t,a=!1,o=!1){a?(f.offset.cancelScheduledValues(e.currentTime),f.offset.setValueAtTime(1,e.currentTime),f.offset.exponentialRampToValueAtTime(.01,e.currentTime+m.value/3)):(f.offset.cancelScheduledValues(e.currentTime),f.offset.setValueAtTime(1,e.currentTime),f.offset.exponentialRampToValueAtTime(.01,e.currentTime+m.value)),y.frequency.cancelScheduledValues(e.currentTime),y.frequency.setTargetAtTime(s(u(t)),e.currentTime,o?.02:.002),M.gain.cancelScheduledValues(e.currentTime),M.gain.setValueAtTime(a?.2:.15,e.currentTime),M.gain.linearRampToValueAtTime(.1,e.currentTime+.2),p.value!=g&&(g=p.value,h.curve=n(g))},noteOff:function(){M.gain.cancelScheduledValues(e.currentTime),M.gain.setTargetAtTime(0,e.currentTime,.01)},params:{cutoff:l,resonance:i,envMod:C,decay:m,distortion:p}}},kick:function(t=a.in){const n=e.createOscillator();n.frequency.value=400;const o=e.createGain();o.gain.value=.3,n.start(),n.frequency.exponentialRampToValueAtTime(50,e.currentTime+.04),o.gain.setValueCurveAtTime([.5,.5,.45,.4,.25,0],e.currentTime,.09),n.stop(e.currentTime+.1),window.setTimeout(()=>o.disconnect(),200),n.connect(o),o.connect(t)},Sampler:l,SamplerDrumMachine:function(t,n=a.in){return r(this,void 0,void 0,function*(){const a=e.createGain();a.gain.value=1,a.connect(n);const o=t.map(l);return{triggers:(yield Promise.all(o)).map(e=>({play:t=>e.play(.7*t,.5*t,a)}))}})},master:a,context:e}}function d(e,t){let n=[];const a={value:t};return{name:e,subscribe:function(e){e(a.value),n.push(e)},get value(){return a.value},set value(e){a.value=e,function(){for(let e of n)e(a.value)}()}}}function m(e,t=!1){return d(e,t)}function f(e,t,n){return Object.assign(d(e,n),{bounds:t})}function v(){let e=d("note set",["C1"]),t=m("new note set",!0);const n=1,r=[[0,0,12,24,27],[0,0,0,12,10,19,26,27],[0,1,7,10,12,13],[0],[0,0,0,12],[0,0,12,14,15,19],[0,0,0,0,12,13,16,19,22,24,25],[0,0,0,7,12,15,17,20,24]];function c(){const t=a(15)+16,n=o(r);e.value=n.map(e=>(function(e){const t=Math.floor(e/12),n=Math.floor(e%12);return`${i.get(n)}${t}`})(e+t))}return{createPattern:function(){1==t.value&&(c(),t.value=!1);const a=[];for(let t=0;t<16;t++){const r=n*(t%4==0?.6:t%3==0?.5:t%2==0?.3:.1);Math.random()<r?a.push({note:o(e.value),accent:Math.random()<.3,glide:Math.random()<.1}):a.push({note:"-",accent:!1,glide:!1})}return a},newNotes:t,noteSet:e}}function p(e){return e<0?0:e>1?1:e}function h(e,t,n,a="red",o="white"){const r=document.createElement("canvas");r.classList.add("dial");const c=r.width=70,i=r.height=50,u=20,s=r.getContext("2d");let l=.5,d=.5,m=0,f=null;function v(){s.clearRect(0,0,c,i);const e=[.8*Math.PI,2.2*Math.PI];s.strokeStyle=a,s.lineWidth=2,s.beginPath(),s.arc(c/2,i/2,u,e[0],e[1]),s.stroke(),s.lineWidth=c/8;const t=e[0]+l*(e[1]-e[0]);if(s.beginPath(),s.arc(c/2,i/2,u,t-.2,t+.2),s.stroke(),m>0){s.strokeStyle="rgba(0,255,0,"+p(m/10)+")",s.lineWidth=c/8;const t=e[0]+l*(e[1]-e[0]);s.beginPath(),s.arc(c/2,i/2,u,t-.2,t+.2),s.stroke()}if(n){s.fillStyle=o,s.font="10px Orbitron";const e=s.measureText(n).width;s.fillText(n,c/2-e/2,i/2+u)}}function h(e){return t[0]+(t[1]-t[0])*e}function g(e){var n;l=(e-t[0])/(t[1]-t[0]),v(),Math.abs(l-d)>.002&&(n=4+Math.floor(Math.abs(l-d)/.001),f&&window.clearInterval(f),m=Math.min(n,10),f=window.setInterval(()=>{m--,v()},100)),d=l}const b={isDragging:!1,handler:[e=>{}]};return r.addEventListener("dblclick",t=>{const n=e;g(n),b.handler.forEach(e=>e(n))}),r.addEventListener("mousedown",e=>{b.isDragging=!0}),window.addEventListener("mousemove",e=>{if(b.isDragging){const t=(e.movementX-e.movementY)/100,n=h(l=p(l+t));g(n),b.handler.forEach(e=>e(n))}}),window.addEventListener("mouseup",e=>{b.isDragging=!1}),v(),{element:r,get value(){return h(l)},set value(e){g(e)},bind:function(e){b.handler.push(e)}}}function g(e,t,n){const a=document.createElement("input");a.classList.add("range");let o=.5,r=.5;function c(e){return t[0]+(t[1]-t[0])*e}function i(e){o=(e-t[0])/(t[1]-t[0]),a.value=u().toString(),r=o}function u(){return Math.trunc(c(o))}a.type="number",a.value=u().toString(),a.min=t[0].toString(),a.max=t[1].toString();const s={isDragging:!1,handler:[e=>{}]};return a.addEventListener("change",e=>{const t=+a.value;i(t),s.handler.forEach(e=>e(t))}),a.addEventListener("dblclick",t=>{const n=e;i(n),s.handler.forEach(e=>e(n))}),a.addEventListener("mousedown",e=>{s.isDragging=!0}),window.addEventListener("mousemove",e=>{if(s.isDragging){const t=(e.movementX-e.movementY)/100,n=c(o=p(o+t));i(n),s.handler.forEach(e=>e(n))}}),window.addEventListener("mouseup",e=>{s.isDragging=!1}),{element:a,get value(){return u()},set value(e){i(e)},bind:function(e){s.handler.push(e)}}}(()=>{function e(e,t){c.set(e,t),i.set(t,e)}e("A",9),e("A#",10),e("B",11),e("C",0),e("C#",1),e("D",2),e("D#",3),e("E",4),e("F",5),e("F#",6),e("G",7),e("G#",8)})();const b={bg:"#222266",note:"#88aacc",accent:"#AA88CC",glide:"#CCAA88",text:"#CCCCFF",highlight:"rgba(255,255,255,0.2)",grid1:"rgba(255,255,255,0.1)",grid2:"rgba(255,255,255,0.3)",dial:"#AA88CC"};function C(e,...t){const n=Array.isArray(e)?e:Object.keys(e).map(t=>e[t]),a=document.createElement("div");return a.classList.add("params",...t),n.forEach(e=>{const t=h(e.value,e.bounds,e.name,b.dial,b.text);t.bind(t=>{e.value=t}),e.subscribe(e=>t.value=e),a.append(t.element)}),a}function y(e,t,n,a,o,r,...c){const i=Array.isArray(r)?r:Object.keys(r).map(e=>r[e]),u=document.createElement("div");u.classList.add("midi-controls","params",...c);var s=document.createElement("div");s.classList.add("param-group",...c),u.append(s);{const n=document.createElement("div");n.classList.add("param-box"),s.append(n);const a=document.createElement("span");a.classList.add("param-name"),a.append(document.createTextNode("MIDI Device:")),n.append(a);const o=D(e,t);n.append(o)}{const e=document.createElement("div");e.classList.add("param-box"),s.append(e);const t=document.createElement("span");t.classList.add("param-name"),t.append(document.createTextNode("MIDI Channel:")),e.append(t);var l=[];for(let e=0;e<16;e++)l.push(e.toString());const a=D(n,l);e.append(a)}(s=document.createElement("div")).classList.add("param-group",...c),u.append(s);{const e=document.createElement("div");e.classList.add("param-box"),s.append(e);const t=document.createElement("span");t.classList.add("param-name"),t.append(document.createTextNode("Control Preset:")),e.append(t);const n=D(a,o);e.append(n)}const d=Array.from(i.values());for(var m=0;m<d.length;m++){const e=d[m];m%2==0&&((s=document.createElement("div")).classList.add("param-group",...c),u.append(s));const t=document.createElement("div");t.classList.add("param-box"),s.append(t);const n=document.createElement("span");n.classList.add("param-name"),n.append(document.createTextNode(e.name+":")),t.append(n);const a=g(e.value,e.bounds,e.name);t.append(a.element),a.bind(t=>{e.value=t}),e.subscribe(e=>a.value=e)}return u}function M(e){const t=document.createElement("button");return t.classList.add("trigger-button"),t.title="Trigger",t.innerText="⟳",e.subscribe(e=>{e?t.classList.add("waiting"):t.classList.remove("waiting")}),t.addEventListener("click",function(){e.value=!0}),t}function w(e){const t=document.createElement("button");return t.classList.add("trigger-button"),t.title="Restore",t.innerText="⤾",e.subscribe(e=>{e?t.classList.add("waiting"):t.classList.remove("waiting")}),t.addEventListener("click",function(){e.value=!0}),t}function T(e,...t){const n=document.createElement("button");return n.classList.add(...t),n.title="Toggle",n.innerText=e.name,n.addEventListener("click",()=>e.value=!e.value),e.subscribe(e=>{e?(n.classList.add("on"),n.classList.remove("off")):(n.classList.add("off"),n.classList.remove("on"))}),n}function D(e,t){const n=document.createElement("select");n.classList.add("option-list"),n.addEventListener("click",()=>e.value=n.selectedIndex);for(let e of t){var a=document.createElement("option");a.text=e,n.add(a)}return n}function P(e){const t=document.createElement("div");return t.classList.add("label"),t.innerText=e,t}function E(...e){const t=document.createElement("div");return t.classList.add("machine"),t.append(...e),t}function O(e,t,...n){const a=document.createElement("div");return a.classList.add("control-group",...n),a.append(e,t),a}function k(...e){const t=document.createElement("div");return t.classList.add("group"),t.append(...e),t}function S(...e){const t=document.createElement("div");return t.classList.add("button-group"),t.append(...e),t}function L(e,t,n,a){const o=document.createElement("div");o.id="ui";const r=function(...e){const t=document.createElement("div");return t.classList.add("controls"),t.append(...e),t}(function(e){return O(P("Autopilot"),k(...e.switches.map(e=>T(e,"autopilot-button"))))}(t),function(e){const t=document.createElement("div");return t.classList.add("parameter-controlled","notegen-note-display"),e.noteSet.subscribe(e=>{t.innerText=e.join(", ")}),O(P("Notegen"),k(M(e.newNotes),t),"notegen-box")}(e.gen),function(e){const t=C([e.dryWet,e.feedback]);return t.classList.add("horizontal"),O(P("Delay"),t)}(e.delay),O(P("Clock"),C([e.clock.bpm],"horizontal")),O(P("Volume"),C([e.masterVolume],"horizontal")),O(P("Meter"),k(function(e){const t=document.createElement("canvas");t.style.width="100%";let n=t.width=200;const a=t.height=50,o=t.getContext("2d"),r=new Uint8Array(e.fftSize),c=new Uint8Array(e.frequencyBinCount/2);return window.requestAnimationFrame(function t(){e.getByteTimeDomainData(r),e.getByteFrequencyData(c),o.clearRect(0,0,n,a),o.fillStyle="white";for(let e=0;e<c.length;e++){const t=c[e]/256;o.fillStyle="rgb("+(c[e]/2+128)+",0,0)",o.fillRect(n*e/c.length,a-1*t*a,n/c.length,1*t*a)}o.strokeStyle="white",o.beginPath(),o.moveTo(0,a/2);for(let e=0;e<r.length;e++){const t=r[e]/128-1;o.lineTo(n*e/r.length,a/2+1.5*t*a/2)}o.stroke(),window.requestAnimationFrame(t)}),t}(n)),"meter")),c=document.createElement("div");c.classList.add("machines");const i=document.createElement("div"),s=a?a.getOutputNames():[],l=[...x.keys()],d=[...I.keys()],m=e.notes.map((t,n)=>E(P("303-0"+(n+1)),k(S(M(t.newPattern),w(t.restorePattern)),function(e,t,n=b){const a=document.createElement("canvas");function o(){const o=e.value,r=a.width=a.clientWidth,c=a.height=200,i=c/50,s=a.getContext("2d");s.font="10px Orbitron",s.fillStyle=n.bg,s.fillRect(0,0,r,c);for(let e=0;e<o.length;e++){s.strokeStyle=e%4==0?n.grid2:n.grid1;const t=r*e/o.length;s.beginPath(),s.moveTo(t,0),s.lineTo(t,c),s.stroke()}for(let e=0;e<80;e++){s.strokeStyle=e%12==0?n.grid2:n.grid1;const t=c-e*i;s.beginPath(),s.moveTo(0,t),s.lineTo(r,t),s.stroke()}for(let e=0;e<o.length;e++){const t=o[e];if("-"===t.note);else{const a=u(t.note)-24,l=r*e/o.length,d=c-a*i,m=r/o.length,f=5;s.fillStyle=t.glide?n.glide:t.accent?n.accent:n.note,s.fillRect(l,d,m,f),s.fillStyle=n.text;const v=l+m/2-s.measureText(t.note).width/2;s.fillText(t.note,v,d)}}s.fillStyle=n.highlight,s.fillRect(r*t.value/o.length,0,r/o.length,c)}return a.classList.add("pattern"),e.subscribe(o),t.subscribe(o),a}(t.pattern,e.clock.currentStep),C(t.parameters),a?y(t.midiDevice,s,t.midiChannel,t.midiPreset,l,t.midiControls,"horizontal"):i))),f=E(P("909-XX"),k(S(M(e.drums.newPattern),w(e.drums.restorePattern)),function(e,t,n,a=b){const o=document.createElement("canvas");function r(){const r=o.width=o.clientWidth,c=o.height=100,i=o.getContext("2d");i.fillStyle=a.bg,i.fillRect(0,0,r,c);for(let e=0;e<16;e+=4){i.strokeStyle=e%4==0?a.grid2:a.grid1;const t=r*e/16;i.beginPath(),i.moveTo(t,0),i.lineTo(t,c),i.stroke()}for(let n=0;n<16;n++){const a=r*n/16;for(let o=0;o<e.value.length;o++){const u=o/e.value.length*c;e.value[o][n]&&(t[o].value?i.fillStyle="rgba(128,0,0,0.4)":i.fillStyle="rgba(136,170,204,"+e.value[o][n]+")",i.fillRect(a,u,r/16,c/e.value.length))}}i.fillStyle=a.highlight,i.fillRect(r*n.value/16,0,r/16,c)}return o.classList.add("pattern"),e.subscribe(r),n.subscribe(r),o}(e.drums.pattern,e.drums.mutes,e.clock.currentStep),function(e){const t=document.createElement("div");return t.classList.add("mutes"),t.append(...e.map(e=>T(e))),t}(e.drums.mutes),a?y(e.drums.midiDevice,s,e.drums.midiChannel,e.drums.midiPreset,d,e.drums.midiControls,"horizontal"):i));return c.append(...m,f),o.append(c,r),o}var A=function(e,t,n,a){return new(n||(n=Promise))(function(o,r){function c(e){try{u(a.next(e))}catch(e){r(e)}}function i(e){try{u(a.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(c,i)}u((a=a.apply(e,t||[])).next())})};const x=new Map([["(Default)",{pitchOffset:0,accentCC:-1,cutoffCC:-1,resonanceCC:-1,envModCC:-1,decayCC:-1,distortionCC:-1}],["Elektron - Digitakt",{pitchOffset:0,accentCC:-1,cutoffCC:74,resonanceCC:75,envModCC:77,decayCC:80,distortionCC:81}],["KORG - minilogue xd)",{pitchOffset:0,accentCC:-1,cutoffCC:43,resonanceCC:44,envModCC:22,decayCC:17,distortionCC:-1}],["Behringer - TD-3-MO",{pitchOffset:12,accentCC:120,cutoffCC:74,resonanceCC:-1,envModCC:-1,decayCC:-1,distortionCC:-1}]]),I=new Map([["(Default)",{pitchBD:0,pitchOH:0,pitchCH:0,pitchSD:0,pitchCP:0,channelBD:-1,channelOH:-1,channelCH:-1,channelSD:-1,channelCP:-1}],["Elektron - Digitakt",{pitchBD:0,pitchOH:0,pitchCH:0,pitchSD:0,pitchCP:0,channelBD:0,channelOH:6,channelCH:5,channelSD:1,channelCP:3}]]);function B(e,t,n,a,o,r,c=16){const i=e.ThreeOh(n,a),u=f("Device",[0,1/0],0),s=f("MIDI Channel",[0,15],0),l=f("Preset",[0,1/0],0),v=d("Pattern",[]),p=d("Pattern",[]),h=m("New Pattern Trigger",!0),g=m("Restore Pattern Trigger",!1),b={cutoff:f("Cutoff",[30,700],400),resonance:f("Resonance",[1,30],15),envMod:f("Env Mod",[0,8e3],4e3),decay:f("Decay",[.1,.9],.5),distortion:f("Dist",[0,80],0)},C={accentCC:f("Acc CC",[-1,127],-1),cutoffCC:f("Cutoff CC",[-1,127],-1),resonanceCC:f("Reso CC",[-1,127],-1),envModCC:f("EnvMod CC",[-1,127],-1),decayCC:f("Decay CC",[-1,127],-1),distortionCC:f("Dist CC",[-1,127],-1),pitchOffset:f("Pitch",[-48,48],0)};if(r.newNotes.subscribe(e=>{1==e&&(h.value=!0)}),b.cutoff.subscribe(e=>i.params.cutoff.value=e),b.resonance.subscribe(e=>i.params.resonance.value=e),b.envMod.subscribe(e=>i.params.envMod.value=e),b.decay.subscribe(e=>i.params.decay.value=e),b.distortion.subscribe(e=>i.params.distortion.value=e),t){function y(e,n){const a=Math.trunc((e.value-e.bounds[0])/(e.bounds[1]-e.bounds[0])*127);if(t&&n.value>=0){t.OutputDevice(u.value,s.value).controlChange(n.value,a)}}u.subscribe(e=>{var n=t.getOutput(e);if(n){const e=n.manufacturer+" "+n.name;console.log("MIDI output device: "+e);for(let e=0;e<16;e++){t.OutputDevice(u.value,e).allNotesOff()}}}),s.subscribe(e=>{}),l.subscribe(e=>{const t=Array.from(x.keys())[l.value];console.log("MIDI control preset: "+t);const n=x.get(t);n&&(C.accentCC.value=n.accentCC,C.cutoffCC.value=n.cutoffCC,C.resonanceCC.value=n.resonanceCC,C.decayCC.value=n.decayCC,C.envModCC.value=n.envModCC,C.distortionCC.value=n.distortionCC,C.pitchOffset.value=n.pitchOffset)}),b.cutoff.subscribe(e=>y(b.cutoff,C.cutoffCC)),b.resonance.subscribe(e=>y(b.resonance,C.resonanceCC)),b.envMod.subscribe(e=>y(b.envMod,C.envModCC)),b.decay.subscribe(e=>y(b.decay,C.decayCC)),b.distortion.subscribe(e=>y(b.distortion,C.distortionCC))}return{step:function(e){if((0===e&&1==h.value||0==v.value.length)&&(p.value=v.value,v.value=r.createPattern(),h.value=!1),0===e&&1==g.value&&p.value.length>0){const e=v.value;v.value=p.value,p.value=e,g.value=!1,h.value=!1}else 1==g.value&&0==p.value.length&&(g.value=!1);const n=v.value[e%c];if("-"!=n.note){if(i.noteOn(n.note,n.accent,n.glide),t){const e=t.OutputDevice(u.value,s.value),a=n.accent?127:100,o=n.glide?100:50;n.accent&&(e.controlChange(C.accentCC.value,n.accent?127:0),setTimeout(()=>{e.controlChange(C.accentCC.value,0)},100)),e.noteOn(n.note,a,o,C.pitchOffset.value)}}else i.noteOff(),t&&t.OutputDevice(u.value,s.value)},pattern:v,parameters:b,midiDevice:u,midiChannel:s,midiPreset:l,midiControls:C,newPattern:h,restorePattern:g}}function H(e,t,n){return A(this,void 0,void 0,function*(){const n=yield e.SamplerDrumMachine(["samples/bd01.mp4","samples/oh01.mp4","samples/hh01.mp4","samples/sd02.mp4","samples/cp01.mp4"]),a=f("MIDI Device",[0,1/0],0),r=f("MIDI Channel",[0,15],0),c=f("Preset",[0,1/0],0),i=d("Drum Pattern",[]),u=d("Drum Pattern",[]),s=[d("Mute BD",!1),d("Mute OH",!1),d("Mute CH",!1),d("Mute SD",!1),d("Mute CP",!1)],l=[f("BD Pitch",[0,48],0),f("OH Pitch",[0,48],0),f("CH Pitch",[0,48],0),f("SD Pitch",[0,48],0),f("CP Pitch",[0,48],0)],v=[f("BD Channel",[-1,15],0),f("OH Channel",[-1,15],0),f("CH Channel",[-1,15],0),f("SD Channel",[-1,15],0),f("CP Channel",[-1,15],0)],p={pitchBD:l[0],channelBD:v[0],pitchOH:l[1],channelOH:v[1],pitchCH:l[2],channelCH:v[2],pitchSD:l[3],channelSD:v[3],pitchCP:l[4],channelCP:v[4]},h=m("New Pattern Trigger",!0),g=m("Restore Pattern Trigger",!1),b={createPatterns:function(e=!1){const t=new Array(16),n=new Array(16),a=new Array(16),r=new Array(16),c=new Array(16),i=o(["electro","fourfloor"]),u=o(["offbeats","closed",e?"offbeats":"none"]),s=o(["backbeat","skip",e?"backbeat":"none"]),l=o(["backbeat","skip",e?"backbeat":"none"]);if("fourfloor"==i)for(let e=0;e<16;e++)e%4==0?t[e]=.9:e%2==0&&Math.random()<.1&&(t[e]=.6);else if("electro"==i)for(let e=0;e<16;e++)0==e?t[e]=1:e%2==0&&e%8!=4&&Math.random()<.5?t[e]=.9*Math.random():Math.random()<.05&&(t[e]=.9*Math.random());if("backbeat"==s)for(let e=0;e<16;e++)e%8==4&&(r[e]=1);else if("skip"==s)for(let e=0;e<16;e++)e%8==3||e%8==6?r[e]=.6+.4*Math.random():e%2==0&&Math.random()<.2?r[e]=.4+.2*Math.random():Math.random()<.1&&(r[e]=.2+.2*Math.random());if("backbeat"==l)for(let e=0;e<16;e++)e%8==4?c[e]=.5:e%8==5&&r[e-1]&&(c[e]=.3+.2*Math.random());else if("skip"==l)for(let e=0;e<16;e++)e%8==3||e%8==6?c[e]=.5+.3*Math.random():(e%8==4||e%8==7)&&c[e-1]&&Math.random()<.5?c[e]=.3+.2*Math.random():e%2==0&&Math.random()<(r[e]?.2:.4)?c[e]=.4+.1*Math.random():Math.random()<.1&&(c[e]=.1+.1*Math.random());if("offbeats"==u)for(let e=0;e<16;e++)e%4==2?n[e]=.4:Math.random()<.3&&(Math.random()<.5?a[e]=.2+.2*Math.random():n[e]=.1+.2*Math.random());else if("closed"==u)for(let e=0;e<16;e++)e%2==0?a[e]=.4:Math.random()<.5&&(a[e]=.2+.3*Math.random());return[t,n,a,r,c]}};return t&&(a.subscribe(e=>{const n=t.getOutput(e);if(n){const e=n.manufacturer+" "+n.name;console.log("MIDI output device: "+e);for(let e=0;e<16;e++){t.OutputDevice(a.value,e).allNotesOff()}}}),r.subscribe(e=>{}),c.subscribe(e=>{const t=Array.from(I.keys())[c.value];console.log("MIDI control preset: "+t);const n=I.get(t);n&&(p.pitchBD.value=n.pitchBD,p.pitchOH.value=n.pitchOH,p.pitchCH.value=n.pitchCH,p.pitchSD.value=n.pitchSD,p.pitchCP.value=n.pitchCP,p.channelBD.value=n.channelBD,p.channelOH.value=n.channelOH,p.channelCH.value=n.channelCH,p.channelSD.value=n.channelSD,p.channelCP.value=n.channelCP)})),{step:function(e){if((0==e&&1==h.value||0==i.value.length)&&(u.value=i.value,i.value=b.createPatterns(!0),h.value=!1),0===e&&1==g.value&&u.value.length>0){const e=i.value;i.value=u.value,u.value=e,g.value=!1,h.value=!1}else 1==g.value&&0==u.value.length&&(g.value=!1);for(let o in i.value){const c=i.value[o][e%i.value[o].length];if(c&&!s[o].value&&(n.triggers[o].play(c),t)){const e=v[o].value>=0?v[o].value:r.value,n=t.OutputDevice(a.value,e),i=Math.floor(127*c);n.noteOn(l[o].value,i)}}if(t){const e=r.value;t.OutputDevice(a.value,e)}},pattern:i,mutes:s,midiDevice:a,midiChannel:r,midiPreset:c,midiControls:p,newPattern:h,restorePattern:g}})}function R(e){const t=f("upcomingMeasure",[0,1/0],0),n=f("measure",[0,1/0],0),a=d("Alter Patterns",!0),o=d("Twiddle With Knobs",!0),r=d("Mute Drum Parts",!0);var c=[0,0];e.clock.currentStep.subscribe(e=>{4===e?t.value=t.value+1:15===e&&(n.value=n.value+1)}),t.subscribe(t=>{a.value&&(t%64==0&&Math.random()<.2&&(console.log("measure #%d: will generate new notes",t),e.gen.newNotes.value=!0,c[0]=c[1]=t),t%16==0?(e.notes.forEach((e,n)=>{Math.random()<.5&&(console.log("measure #%d: will generate new pattern for unit %d",t,n),e.newPattern.value=!0,c[n]=t)}),Math.random()<.3&&(console.log("measure #%d: will generate new pattern for drums",t),e.drums.newPattern.value=!0,t)):t%16==4&&e.notes.every((e,n)=>{const a=t-c[n];if(a>=20&&Math.random()<.5)return console.log("measure #%d: will generate new pattern for unit %d (age %d)",t,n,a),e.newPattern.value=!0,void(c[n]=t)}))}),n.subscribe(t=>{if(r.value){const n=[Math.random()<.2,Math.random()<.5,Math.random()<.5,Math.random()<.5,Math.random()<.8],a=e.drums.mutes.reduce((e,t)=>t.value?e:e+1,0);t%8==0?(console.log("measure #%d: may mute drum parts",t),e.drums.mutes.forEach((e,t)=>{e.value=n[t]})):t%8==7?(console.log("measure #%d: may mute drum parts",t),e.drums.mutes.forEach((e,t)=>{Math.random()<.5&&(e.value||(e.value=n[t]))})):t%2==0&&(console.log("measure #%d: may unmute drum parts",t),e.drums.mutes.forEach((e,t)=>{Math.random()<1/(a+1)&&e.value&&(e.value=n[t])}))}});const i=[...e.notes.flatMap(e=>Object.values(e.parameters)),...[e.delay.feedback,e.delay.dryWet]].map(e=>(function(e,t=.0025){const[n,a]=e.bounds;let o=0,r=t*(a-n),c=0,i=(n+a)/2;return{step:()=>{i!=e.value?(o=0,i=e.value,c=200):(c>0&&c--,c<100&&(o*=c>0?.8:.98,o+=(Math.random()-.5)*r,e.value+=o,i=e.value,e.value>n+.8*(a-n)?o-=Math.random()*r:e.value<n+.2*(a-n)&&(o+=Math.random()*r)))}}})(e));return window.setInterval(()=>{o.value&&i.forEach(e=>e.step())},100),{switches:[a,o,r]}}function V(){const e=f("BPM",[70,200],142),t=f("Current Step",[0,15],0),n=function(e,t=4,n=0){let a=e,o=(e,t)=>{},r=(new Date).getTime(),c=0;return window.setTimeout(function e(){const i=(new Date).getTime()-r;o(i,c);const u=c%2==0?1+n:1-n;c++,window.setTimeout(e,u*(6e4/a)/t)},6e4/e/t),{bind:function(e){o=e},setBpm:e=>a=e}}(e.value,4,0);return e.subscribe(n.setBpm),n.bind((e,n)=>{t.value=n%16}),{bpm:e,currentStep:t}}var N=null;try{window.navigator.requestMIDIAccess().then(e=>{console.log("MIDI Ready!"),(N=function(e,t=100){function n(t){if("number"==typeof t){if(0==t)return null;var n=Array.from(e.outputs.keys())[t-1];return e.outputs.get(n)}return e.outputs.get(t)}return{noteLength:t,listInputsAndOutputs:function(){for(var t of e.inputs){var n=t[1];console.log("Input port [type:'"+n.type+"'] id:'"+n.id+"' manufacturer:'"+n.manufacturer+"' name:'"+n.name+"' version:'"+n.version+"'")}for(var t of e.outputs){var a=t[1];console.log("Output port [type:'"+a.type+"'] id:'"+a.id+"' manufacturer:'"+a.manufacturer+"' name:'"+a.name+"' version:'"+a.version+"'")}},getOutputNames:function(){var t=[];for(var n of(t.push("(None)"),e.outputs)){var a=n[1];t.push(a.name)}return t},getOutput:n,OutputDevice:function(e,t){return{noteOn:function(a,o=100,r=100,c=0){if(a<0)return;const i="number"==typeof a?a+60-12:u(a),s=[144+t,i+c,o],l=[128+t,i+c,64];var d=n(e);d&&(d.send(s),d.send(l,window.performance.now()+r))},noteOff:function(a,o=0){if(a<0)return;var r="number"==typeof a?a+60-12:u(a);const c=[128+t,r+=o,64];var i=n(e);i&&i.send(c)},allNotesOff:function t(){var a=n(e);a&&a.send(t)},controlChange:function(a,o,r=32,c=96){if(a<0)return;o=Math.max(r,o),o=Math.min(c,o);const i=[176+t,a,o];var u=n(e);u&&u.send(i)}}},startClock:function t(n){for(var a of e.outputs)a[1].send([248]);window.setTimeout(t,6e4/n.value*(1/24))}}}(e)).listInputsAndOutputs()}).catch(e=>{console.log("Error accessing MIDI devices: "+e)})}catch(e){console.log("Error accessing MIDI devices: "+e)}!function(e,t,n,a="Click, tap or press any key to start"){const o=document.createElement("button");o.id="_start_button";const r=document.createElement("div");r.id="_intro_text",o.append(r),r.innerHTML=t+"<br><br>"+n+"<br><br>"+a,document.head.insertAdjacentHTML("beforeend",`\n    <style>\n        body {\n            height: 95vh;  margin: 0; padding: 0;\n        }\n        #${o.id} {\n            width: 100%;\n            height: 100%;\n            display: block;\n            position: absolute;\n            top: 0;\n            left: 0;\n            z-index: 50;\n            color:grey;\n            background-color: black;\n        }\n\n        #${r.id} {\n            max-width: 640px;\n            font-size: 1.5em;\n            margin-left: auto;\n            margin-right: auto;\n            text-align:left;\n            font-family: monospace;\n        }\n    </style>\n    `),document.body.append(o);let c=!1;function i(){c||(c=!0,e(),o.style.display="none")}o.addEventListener("click",i),window.addEventListener("keydown",i)}(function(){return A(this,void 0,void 0,function*(){const e=l(),t=V(),n=function(e){const t=f("Dry/Wet",[0,.5],.5),n=f("Feedback",[0,.9],.3),a=f("Time",[0,2],.3),o=e.DelayInsert(a.value,t.value,n.value);return t.subscribe(e=>o.wet.value=e),n.subscribe(e=>o.feedback.value=e),a.subscribe(e=>o.delayTime.value=e),{dryWet:t,feedback:n,delayTime:a,inputNode:o.in}}(e);t.bpm.subscribe(e=>n.delayTime.value=60/e*.75);const a=v(),o={notes:[B(e,N,"sawtooth",n.inputNode,t.bpm,a),B(e,N,"square",n.inputNode,t.bpm,a)],drums:yield H(e,N,t.bpm),gen:a,delay:n,clock:t,masterVolume:f("Volume",[0,1],.5)};N&&(console.log("MIDI output enabled"),t.bpm.subscribe(e=>N.noteLength=6e4/e*.25),N.startClock(t.bpm)),o.masterVolume.subscribe(t=>{e.master.in.gain.value=t}),t.currentStep.subscribe(e=>[...o.notes,o.drums].forEach(t=>t.step(e)));const r=R(o),c=L(o,r,e.master.analyser,N);document.body.append(c)})},"Spicy Endless Acid Banger","A collaboration between human and algorithm by Vitling, spiced up by Zykure")}]);